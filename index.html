<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cartões de Visita dos Palhaços</title>
    <!-- Tailwind CSS para o estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonte divertida para os nomes dos palhaços -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Balsamiq+Sans:wght@700&display=swap" rel="stylesheet">
    <style>
        /* Estilo customizado para a fonte e animações */
        .font-balsamiq { font-family: 'Balsamiq Sans', cursive; }
        .form-input { @apply w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-shadow; }
        .btn-primary { @apply py-2 px-6 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors shadow-md; }
        .btn-secondary { @apply py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- O conteúdo do nosso aplicativo será renderizado aqui -->
    <div id="app-container"></div>

    <!-- Modal para adicionar/editar palhaços -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h2 id="modal-title" class="text-2xl font-bold mb-6"></h2>
            <form id="modal-form">
                <div class="space-y-6">
                    <!-- Campos Principais -->
                    <div>
                        <label for="foto" class="block text-sm font-medium text-gray-700">Foto do Palhaço</label>
                        <input type="file" id="foto" accept="image/*" class="form-input mt-1 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100"/>
                        <img id="foto-preview" src="" class="hidden mt-4 w-32 h-32 rounded-full object-cover mx-auto"/>
                    </div>
                    <input type="text" id="nomePalhaco" placeholder="Nome do Palhaço" class="form-input" required />
                    <input type="text" id="profissao" placeholder="Profissão do Palhaço (Ex: Mágico, Músico)" class="form-input" required />
                    <textarea id="bio" placeholder="Escreva uma bio divertida..." class="form-input" rows="4"></textarea>
                    
                    <!-- Blocos Personalizáveis -->
                    <div class="border-t pt-6">
                        <h3 class="text-lg font-semibold text-gray-800">Blocos Personalizáveis</h3>
                        <div id="blocos-container" class="mt-4 space-y-4">
                            <!-- Novos blocos serão adicionados aqui -->
                        </div>
                        <button type="button" onclick="adicionarBloco()" class="mt-4 btn-secondary">Adicionar Bloco</button>
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" onclick="closeModal()" class="btn-secondary">Cancelar</button>
                    <button type="submit" id="save-button" class="btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase e nosso código JavaScript -->
    <script type="module">
        // Importando as funções do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, setDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";

        // --- Configuração do Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyDqPIO6qgLQSG_p5Vg2z5qRVJfQqiK282s",
            authDomain: "cartoes-palhacos-app.firebaseapp.com",
            projectId: "cartoes-palhacos-app",
            storageBucket: "cartoes-palhacos-app.appspot.com", // Verifique se o final é appspot.com
            messagingSenderId: "455690604804",
            appId: "1:455690604804:web:0b5a909a5ee2dec9e50051"
        };

        // Inicializa os serviços do Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app); // Inicializa o Storage
        const appId = firebaseConfig.projectId;

        // Autenticação anônima
        onAuthStateChanged(auth, async (user) => {
            if (!user) await signInAnonymously(auth);
            router();
        });

        const appContainer = document.getElementById('app-container');

        // --- Funções de Renderização ---

        function renderLoading(text = 'Carregando...') {
            appContainer.innerHTML = `<div class="flex flex-col justify-center items-center h-screen"><div class="animate-spin rounded-full h-32 w-32 border-b-4 border-red-500"></div><p class="mt-4 text-lg text-gray-600">${text}</p></div>`;
        }

        async function renderClownCard(clownId) {
            renderLoading();
            const docRef = doc(db, `artifacts/${appId}/public/data/clowns`, clownId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                const blocosHtml = (data.blocos || []).map(bloco => {
                    if (bloco.tipo === 'link') {
                        return `<a href="${bloco.conteudo}" target="_blank" rel="noopener noreferrer" class="block w-full text-center bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition-all">${bloco.titulo}</a>`;
                    }
                    if (bloco.tipo === 'video') {
                        const videoId = bloco.conteudo.split('v=')[1]?.split('&')[0] || bloco.conteudo.split('/').pop();
                        return `
                            <div class="mt-4">
                                <h3 class="font-semibold text-lg mb-2">${bloco.titulo}</h3>
                                <div class="aspect-w-16 aspect-h-9">
                                    <iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="rounded-lg shadow-md"></iframe>
                                </div>
                            </div>`;
                    }
                    return `<div class="text-left"><h3 class="font-semibold text-lg">${bloco.titulo}</h3><p class="text-gray-700">${bloco.conteudo}</p></div>`;
                }).join('');

                appContainer.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4 bg-gray-200">
                        <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden my-8">
                            <img src="${data.fotoUrl || 'https://placehold.co/600x400/fecaca/c53030?text=Foto'}" alt="Foto de ${data.nomePalhaco}" class="w-full h-56 object-cover">
                            <div class="p-6 text-center">
                                <h1 class="text-4xl font-bold text-gray-800 font-balsamiq">${data.nomePalhaco}</h1>
                                <p class="text-md text-red-600 font-semibold mt-1">${data.profissao}</p>
                                <p class="text-gray-700 my-4 text-left">${data.bio}</p>
                                <div class="space-y-4 mt-6">${blocosHtml}</div>
                                <a href="https://www.instagram.com/narizesdeplantao_/" target="_blank" rel="noopener noreferrer" class="mt-8 inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-full text-white bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 transition-all duration-300 shadow-lg">
                                    Nosso Instagram
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                appContainer.innerHTML = `<div class="text-center p-4"><h2>Oops! Palhaço não encontrado.</h2></div>`;
            }
        }
        
        function renderAdminPanel() {
            renderLoading();
            const clownsCollectionRef = collection(db, `artifacts/${appId}/public/data/clowns`);
            onSnapshot(clownsCollectionRef, (snapshot) => {
                const clownsList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const clownsHtml = clownsList.map(clown => `
                    <div class="bg-white rounded-xl shadow-lg p-5 flex flex-col justify-between">
                        <div class="flex items-start">
                            <img src="${clown.fotoUrl || 'https://placehold.co/100/fecaca/c53030?text=?'}" class="w-16 h-16 rounded-full object-cover mr-4">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">${clown.nomePalhaco}</h2>
                                <p class="text-sm text-gray-500">${clown.profissao}</p>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t flex space-x-3">
                            <button onclick='openModalForEdit(${JSON.stringify(clown).replace(/'/g, "&apos;")})' class="flex-1 btn-secondary">Editar</button>
                            <button onclick="handleDelete('${clown.id}', '${clown.fotoPath || ''}')" class="flex-1 btn-secondary bg-red-100 text-red-700 hover:bg-red-200">Apagar</button>
                        </div>
                    </div>
                `).join('');

                appContainer.innerHTML = `
                    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
                        <header class="flex justify-between items-center mb-8">
                            <h1 class="text-4xl font-bold text-gray-800">Painel do Coordenador</h1>
                            <button onclick="openModalForNew()" class="btn-primary">Adicionar Palhaço</button>
                        </header>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${clownsHtml}</div>
                    </div>
                `;
            });
        }

        window.adicionarBloco = (bloco = { tipo: 'texto', titulo: '', conteudo: '' }) => {
            const container = document.getElementById('blocos-container');
            const div = document.createElement('div');
            div.className = 'p-4 border rounded-lg bg-gray-50 relative';
            div.innerHTML = `
                <button type="button" onclick="this.parentElement.remove()" class="absolute top-2 right-2 text-gray-400 hover:text-red-500">&times;</button>
                <select class="bloco-tipo form-input mb-2">
                    <option value="texto" ${bloco.tipo === 'texto' ? 'selected' : ''}>Texto Simples</option>
                    <option value="link" ${bloco.tipo === 'link' ? 'selected' : ''}>Botão de Link</option>
                    <option value="video" ${bloco.tipo === 'video' ? 'selected' : ''}>Vídeo do YouTube</option>
                </select>
                <input type="text" placeholder="Título do Bloco" class="bloco-titulo form-input mb-2" value="${bloco.titulo}" required>
                <input type="text" placeholder="Conteúdo (texto, URL do link ou URL do vídeo)" class="bloco-conteudo form-input" value="${bloco.conteudo}" required>
            `;
            container.appendChild(div);
        };

        window.openModalForNew = () => {
            const form = document.getElementById('modal-form');
            form.reset();
            form.removeAttribute('data-clown-id');
            form.removeAttribute('data-foto-path');
            document.getElementById('blocos-container').innerHTML = '';
            document.getElementById('foto-preview').classList.add('hidden');
            document.getElementById('modal-title').innerText = 'Adicionar Novo Palhaço';
            document.getElementById('modal').classList.remove('hidden');
        };

        window.openModalForEdit = (clown) => {
            openModalForNew();
            document.getElementById('modal-title').innerText = 'Editar Palhaço';
            const form = document.querySelector('#modal-form');
            form.dataset.clownId = clown.id;
            form.dataset.fotoPath = clown.fotoPath || '';

            document.getElementById('nomePalhaco').value = clown.nomePalhaco;
            document.getElementById('profissao').value = clown.profissao;
            document.getElementById('bio').value = clown.bio;
            
            if(clown.fotoUrl) {
                const preview = document.getElementById('foto-preview');
                preview.src = clown.fotoUrl;
                preview.classList.remove('hidden');
            }

            if (clown.blocos) {
                clown.blocos.forEach(bloco => adicionarBloco(bloco));
            }
        };

        window.closeModal = () => document.getElementById('modal').classList.add('hidden');

        document.getElementById('modal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const saveButton = document.getElementById('save-button');
            saveButton.disabled = true;
            saveButton.innerText = 'Salvando...';

            const clownId = e.target.dataset.clownId;
            const fotoFile = document.getElementById('foto').files[0];
            let fotoUrl = document.getElementById('foto-preview').src;
            let fotoPath = e.target.dataset.fotoPath || '';

            if (fotoFile) {
                renderLoading('Enviando foto...');
                fotoPath = `fotos/${Date.now()}-${fotoFile.name}`;
                const storageRef = ref(storage, fotoPath);
                await uploadBytes(storageRef, fotoFile);
                fotoUrl = await getDownloadURL(storageRef);
            }

            const blocos = Array.from(document.querySelectorAll('#blocos-container > div')).map(div => ({
                tipo: div.querySelector('.bloco-tipo').value,
                titulo: div.querySelector('.bloco-titulo').value,
                conteudo: div.querySelector('.bloco-conteudo').value
            }));

            const clownData = {
                nomePalhaco: document.getElementById('nomePalhaco').value,
                profissao: document.getElementById('profissao').value,
                bio: document.getElementById('bio').value,
                fotoUrl,
                fotoPath,
                blocos
            };

            try {
                const docRef = clownId ? doc(db, `artifacts/${appId}/public/data/clowns`, clownId) : doc(collection(db, `artifacts/${appId}/public/data/clowns`));
                await setDoc(docRef, clownData, { merge: true });
                closeModal();
                router(); // Recarrega a view atual
            } catch (error) {
                console.error("Erro ao salvar:", error);
                alert("Não foi possível salvar.");
            } finally {
                saveButton.disabled = false;
                saveButton.innerText = 'Salvar';
            }
        });

        window.handleDelete = async (id, fotoPath) => {
            if (confirm('Tem certeza que deseja apagar este palhaço?')) {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/clowns`, id));
                    if (fotoPath) {
                        const fotoRef = ref(storage, fotoPath);
                        await deleteObject(fotoRef);
                    }
                } catch (error) {
                    console.error("Erro ao deletar:", error);
                    alert("Ocorreu um erro ao apagar. Verifique o console.");
                }
            }
        };

        function router() {
            const hash = window.location.hash;
            if (hash.startsWith('#/palhaco/')) {
                renderClownCard(hash.split('/')[2]);
            } else if (hash === '#admin') {
                renderAdminPanel();
            } else {
                renderHomePage();
            }
        }

        window.addEventListener('hashchange', router);
        router();
    </script>
</body>
</html>
