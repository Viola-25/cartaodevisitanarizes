<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Narizes de Plantão - Cartões Online</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Google Fonts & Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700&display=swap" />
  <style>
    :root { --primary: #E74C3C; --secondary: #F39C12; --accent: #3498DB; --background: #FDF8F5; --card: #fff; --radius: 16px; }
    body { background: var(--background); margin:0; font-family: 'Nunito', sans-serif; color: #333; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    .header { background: var(--primary); color:#fff; padding:24px 0; text-align:center; font-family: 'Fredoka One', cursive; font-size:2.2em;}
    .admin-btns { display:flex; gap:12px; margin:24px 0; }
    .btn, button { padding: 10px 24px; background:var(--primary); color:#fff; border:none; border-radius:var(--radius); font-weight:700; cursor:pointer; transition:all .2s; font-family: 'Nunito', sans-serif; }
    .btn.secondary { background:var(--secondary);} .btn.accent { background: var(--accent); }
    .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 8px #0002; }
    .btn:disabled { opacity:0.6; cursor: not-allowed;}
    .container { max-width:560px; margin:24px auto 0; padding: 0 16px; }
    /* --- MELHORIA: Layout em grade para o painel de admin --- */
    .admin-container { max-width: 1200px; margin: 24px auto 0; padding: 0 16px; }
    .card-list { display: grid; grid-template-columns: 1fr; gap: 16px; }
    .admin-card { background:var(--card); border-radius:var(--radius); box-shadow:0 4px 16px #E74C3C1A; padding:20px; display:flex; flex-wrap: wrap; gap:20px; align-items:center; animation: fadeIn .5s ease; }
    .card-photo { width:82px; height:82px; border-radius:50%; object-fit:cover; background:#eee; flex-shrink:0;}
    .card-info { flex: 1; min-width: 200px; }
    .card-actions { display:flex; flex-direction: column; gap:8px; align-items: flex-start; }
    .copiar-link { background: var(--accent); }
    .ok-copied { color:var(--accent); font-size:0.95em; margin-left:8px }
    .card-link { font-size: 0.9em; color: #555; background: #f4f4f4; padding: 4px 10px; border-radius: 8px; display: inline-block; word-break: break-all; margin-bottom: 8px; }
    .logout { background:#888; }
    .modal-bg { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:#0008; align-items:center; justify-content:center; z-index:1000;}
    .modal-bg.active { display:flex;}
    .modal-box { background:#fff; border-radius:var(--radius); box-shadow:0 4px 26px #0003; max-width:98vw; width:96vw; max-width:420px; padding:24px; position:relative; max-height:90vh; overflow-y:auto;}
    .modal-title { font-family:'Fredoka One',cursive; font-size:1.4em; margin-bottom:24px;}
    .form-grp { margin-bottom:16px;}
    .form-grp label { font-weight:600; font-size:1em; margin-bottom:4px; display:block;}
    .form-grp input, .form-grp textarea { width:100%; padding:8px 12px; border-radius:10px; border:1px solid #ddd; font-size:1em; box-sizing: border-box; }
    .form-grp textarea { min-height:60px;}
    .custom-links { margin-top:8px;}
    .custom-link-row { display:flex; gap:8px; margin-bottom:7px;}
    /* --- NOVO: Estilos para seções reordenáveis --- */
    .form-section { border: 1px solid #eee; border-radius: 10px; padding: 12px; background: #fafafa; cursor: grab; }
    .form-section-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .form-section-header i { color: #aaa; }
    .form-section-header label { margin-bottom: 0; }
    .custom-link-row input { flex:1; }    
    .btn-icon { background: none; border: none; padding: 4px 8px; cursor: pointer; }
    .btn-danger { background: var(--primary); color: #fff; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 1em; }
    .close-modal { position:absolute; top:10px; right:16px; background:none; border:none; color:#d00; font-size:1.6em; cursor:pointer;}
    @media (max-width:600px){
      .modal-box { max-width:100vw; width:97vw;}
      .header { font-size:1.8em; }
      .admin-card { flex-direction: column; align-items: flex-start; gap: 16px; }
      .card-actions { width: 100%; }
    }
    /* --- MELHORIA: Grid em telas maiores --- */
    @media (min-width: 900px) {
      .card-list { grid-template-columns: repeat(2, 1fr); gap: 24px; }
      .card-actions { align-items: flex-end; }
    }
    .center-card-indv { min-height:100vh; display:flex; align-items:center; justify-content:center; background: linear-gradient(135deg, var(--primary) 60%, var(--secondary) 100%); padding: 20px 0; }
    .indv-card { background:#fff; border-radius:30px; padding:40px 32px; max-width:440px; width:96vw; box-shadow:0 8px 40px #00000033; display:flex; flex-direction:column; align-items:center; animation: fadeIn .5s ease; }
    /* --- NOVO: Wrapper para a foto com borda degradê --- */
    .indv-photo-wrapper {
      padding: 4px; /* Espessura da borda degradê */
      border-radius: 50%;
      margin-bottom: 16px;
      background: linear-gradient(135deg, var(--primary), var(--secondary)); /* Degradê padrão */
    }
    .indv-photo { width:150px; height:150px; border-radius:50%; object-fit:cover; border:4px solid var(--background); display: block; }
    .indv-name { font-family:'Fredoka One', cursive; font-size:2em;  color:var(--primary); }
    .indv-role { color:var(--secondary); font-weight:700; margin-bottom:10px; font-size: 1.1em; }
    .indv-bio { margin:12px 0 24px 0; text-align:center;  font-size:1.07em; color:#555; max-width:360px; line-height: 1.5; }
    .soc-icons { display:flex; gap:16px; margin-bottom:24px; }
    .soc-icons a { font-size:2.2em; color:var(--accent); transition: transform .2s ease; }
    .soc-icons a:hover { transform: scale(1.1); }
    .custom-links-indv { margin-bottom:24px; display:flex; justify-content: center; gap:12px; flex-wrap:wrap; }
    .custom-links-indv a { background: var(--secondary); color:#fff; padding:8px 16px; border-radius:12px; font-size:1em; display:inline-block; text-decoration: none; font-weight: 600; transition: all .2s ease; }
    .custom-links-indv a:hover { transform: translateY(-2px); box-shadow: 0 4px 8px #0002; }
    .ndp-logo { margin-top:24px; font-size:1em; color:#222b; letter-spacing:1px; }
    .notfound { color:#fff; text-align:center; font-size:1.3em; }
    /* Spinner e Animações */
    /* --- NOVO: Estilos do Carrossel de Imagens --- */
    .indv-additional-images {
      position: relative;
      margin-top: 20px;
      width: 100%;
      max-width: 300px; /* Define um tamanho máximo para o carrossel */
      margin-left: auto;
      margin-right: auto;
      overflow: hidden;
      margin-bottom: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .carousel-track {
      display: flex;
      transition: transform 0.4s ease-in-out;
    }
    .indv-additional-images img {
      width: 100%;
      flex-shrink: 0;
      aspect-ratio: 1 / 1; /* Imagens quadradas */
      object-fit: cover;
    }
    .carousel-btn {
      position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.4); color: white; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s;
    }
    .carousel-btn.prev { left: 10px; }
    .carousel-btn.next { right: 10px; }
    .carousel-btn:disabled { opacity: 0.3; cursor: default; }
    .project-instagram-link {
      margin-top: 32px;
      color: #555;
      text-decoration: none;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 1.1em;
      transition: color .2s;
    }
    .project-instagram-link:hover {
      color: var(--primary);
    }
    .project-motto {
      margin-top: 8px;
      color: #666;
      font-size: 0.95em;
      font-style: italic;
    }
    .spinner { width: 50px; height: 50px; border: 5px solid #fff3; border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .btn.copied { background: #27ae60 !important; }

  </style>
</head>
<body>
  <div id="main"></div>
  <div class="modal-bg" id="modal-bg"></div>

  <!-- Configuração do Firebase (carregada de um arquivo local não versionado) -->
  <script src="firebase-config.js"></script>
  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js"; 
    import { getFirestore, collection, getDocs, addDoc, doc, deleteDoc, getDoc, updateDoc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import { getStorage, ref as stRef, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    function getParamId() { const url = new URL(window.location.href); return url.searchParams.get('id'); }

    // --- NOVO: formata username ou link completo para URL final ---
    function formatLink(prefix, username) {
      if (!username) return "";
      username = username.trim();
      // se o usuário já colocou um link completo, mantém como está
      if (username.startsWith("http")) return username;
      // remove @ inicial caso exista
      return `${prefix}${username.replace(/^@/, "")}`;
    }

    async function getPalhacos() {
      const palhacos = [];
      const q = query(collection(db, "palhacos"), orderBy("name", "asc"));
      const querySnapshot = await getDocs(q);
      querySnapshot.forEach((doc) => { let d = doc.data(); d.key = doc.id; palhacos.push(d); });
      return palhacos;
    }
    async function getById(id) {
      // --- MELHORIA: Usar 'where' para buscar diretamente no banco de dados ---
      const palhacosRef = collection(db, "palhacos");
      const q = query(palhacosRef, where("id", "==", id));
      const querySnapshot = await getDocs(q);
      if (querySnapshot.empty) {
        return null;
      }
      const doc = querySnapshot.docs[0];
      // Retorna os dados do documento e a chave (ID do documento)
      return { ...doc.data(), key: doc.id };
    }
    async function createPalhaco(data) { await addDoc(collection(db, "palhacos"), data); }
    async function updatePalhaco(key, data) { const ref = doc(db, "palhacos", key); await updateDoc(ref, data); }
    async function delPalhaco(key) { await deleteDoc(doc(db, "palhacos", key)); }

    async function renderIndvCard(id) {
      const dom = document.getElementById('main');
      dom.innerHTML = '<div class="center-card-indv"><div class="spinner"></div></div>';
      const palhaco = await getById(id);
      if (!palhaco) {
        dom.innerHTML = `<div class="center-card-indv"><div class="notfound">Palhaço não encontrado!<br><a href="./" style="color:#fff;text-decoration:underline;">Voltar à lista</a></div></div>`;
        return;
      }
      let socIcons = '';
      if (palhaco.instagram) socIcons += `<a href="${formatLink("https://instagram.com/", palhaco.instagram)}" target="_blank" rel="noreferrer"><i class="fab fa-instagram"></i></a>`;
      if (palhaco.facebook) socIcons += `<a href="${formatLink("https://facebook.com/", palhaco.facebook)}" target="_blank" rel="noreferrer"><i class="fab fa-facebook"></i></a>`;
      if (palhaco.twitter) socIcons += `<a href="${formatLink("https://x.com/", palhaco.twitter)}" target="_blank" rel="noreferrer"><i class="fab fa-x-twitter"></i></a>`;
      if (palhaco.linkedin) socIcons += `<a href="${formatLink("https://linkedin.com/in/", palhaco.linkedin)}" target="_blank" rel="noreferrer"><i class="fab fa-linkedin"></i></a>`;
      if (palhaco.website) socIcons += `<a href="${formatLink("", palhaco.website)}" target="_blank" rel="noreferrer"><i class="fas fa-globe"></i></a>`;
      let customLinksHTML = '';
      if (palhaco.customLinks && palhaco.customLinks.length) {
        customLinksHTML = `<div class="custom-links-indv">`;
        palhaco.customLinks.forEach(lk => { if (lk.title && lk.url) customLinksHTML += `<a href="${lk.url}" target="_blank" rel="noreferrer">${lk.title}</a>`; });
        customLinksHTML += '</div>';
      }
      let additionalImagesHTML = '';
      if (palhaco.additionalImages && palhaco.additionalImages.length) {
        const images = palhaco.additionalImages.filter(imgUrl => imgUrl); // Filtra URLs vazias
        if (images.length > 0) {
          additionalImagesHTML = `<div class="indv-additional-images" id="image-carousel" style="margin-bottom: 24px;">
            <div class="carousel-track">`;
          images.forEach(imgUrl => {
            additionalImagesHTML += `<img src="${imgUrl}" alt="Imagem adicional" onerror="this.style.display='none';" />`;
          });
          additionalImagesHTML += `</div>
            <button class="carousel-btn prev" id="carousel-prev"><i class="fa fa-chevron-left"></i></button>
            <button class="carousel-btn next" id="carousel-next"><i class="fa fa-chevron-right"></i></button>
          </div>`;
        }
      }

      // --- NOVO: Monta o corpo do cartão na ordem definida pelo usuário ---
      const sectionOrder = palhaco.sectionOrder || ['bio', 'social', 'images', 'links'];
      const sections = {
        bio: `<div class="indv-bio">${palhaco.bio ?? ''}</div>`,
        social: `<div class="soc-icons">${socIcons}</div>`,
        images: additionalImagesHTML,
        links: customLinksHTML
      };
      let cardBodyHTML = '';
      sectionOrder.forEach(sectionId => {
        if (sections[sectionId]) cardBodyHTML += sections[sectionId];
      });

      // Define o estilo do background: usa as cores personalizadas se existirem, senão usa o padrão da classe CSS.
      let backgroundStyle = '';
      let nameColorStyle = '';
      let roleColorStyle = '';
      let photoBorderStyle = ''; // --- NOVO: Estilo para a borda da foto ---
      if (palhaco.color1 && palhaco.color2) {
        backgroundStyle = `style="background: linear-gradient(135deg, ${palhaco.color1} 60%, ${palhaco.color2} 100%)"`;
        nameColorStyle = `style="color: ${palhaco.color1}"`;
        roleColorStyle = `style="color: ${palhaco.color2}"`;
        photoBorderStyle = `style="background: linear-gradient(135deg, ${palhaco.color1}, ${palhaco.color2})"`;
      }
      dom.innerHTML = `<div class="center-card-indv" ${backgroundStyle}>
        <div class="indv-card">
          <div class="indv-photo-wrapper" ${photoBorderStyle}>
            <img src="${palhaco.photo}" alt="palhaço" class="indv-photo" onerror="this.src='https://i.imgur.com/wIxRvus.png';" />
          </div>
          <div class="indv-name" ${nameColorStyle}>${palhaco.name}</div>
          <div class="indv-role" ${roleColorStyle}>${palhaco.jobTitle ?? ''}</div>
          ${cardBodyHTML}
          <a href="https://instagram.com/narizesdeplantao_" target="_blank" rel="noreferrer" class="project-instagram-link">
            <i class="fab fa-instagram"></i> @narizesdeplantao_
          </a>
          <p class="project-motto">A gente cuida da gente para cuidar de gente</p>
        </div>
      </div>`;
      // --- NOVO: Inicializa o carrossel após renderizar o HTML ---
      initCarousel();
    }

    function initCarousel() {
      const carousel = document.getElementById('image-carousel');
      if (!carousel) return;

      const track = carousel.querySelector('.carousel-track');
      const slides = Array.from(track.children);
      const nextButton = document.getElementById('carousel-next');
      const prevButton = document.getElementById('carousel-prev');
      
      if (slides.length <= 1) return; // Não faz nada se tiver 1 ou 0 imagens
      
      const slideWidth = slides[0].getBoundingClientRect().width;
      let currentIndex = 0;
      
      // --- Lógica de arrastar/swipe ---
      let isDragging = false, startPos = 0, currentTranslate = 0, prevTranslate = 0;

      const getPositionX = e => e.type.includes('mouse') ? e.pageX : e.touches[0].clientX;

      const dragStart = (e) => {
        isDragging = true;
        startPos = getPositionX(e);
        track.style.transition = 'none'; // Desativa a transição durante o arrasto
        carousel.style.cursor = 'grabbing';
      };

      const dragging = (e) => {
        if (!isDragging) return;
        const currentPosition = getPositionX(e);
        currentTranslate = prevTranslate + currentPosition - startPos;
        track.style.transform = `translateX(${currentTranslate}px)`;
      };

      const dragEnd = () => {
        if (!isDragging) return;
        isDragging = false;
        track.style.transition = 'transform 0.4s ease-in-out'; // Reativa a transição
        carousel.style.cursor = 'grab';
        const movedBy = currentTranslate - prevTranslate;

        // Move para o próximo/anterior se o swipe for maior que 50px
        if (movedBy < -50 && currentIndex < slides.length - 1) currentIndex++;
        if (movedBy > 50 && currentIndex > 0) currentIndex--;

        moveToSlide(currentIndex);
      };

      // Adiciona os eventos de toque e mouse
      carousel.addEventListener('mousedown', dragStart);
      carousel.addEventListener('touchstart', dragStart);
      carousel.addEventListener('mouseup', dragEnd);
      carousel.addEventListener('touchend', dragEnd);
      carousel.addEventListener('mouseleave', dragEnd);
      carousel.addEventListener('mousemove', dragging);
      carousel.addEventListener('touchmove', dragging);
      // --- Fim da lógica de arrastar ---

      // Mostra as setas
      nextButton.style.opacity = '1';
      prevButton.style.opacity = '1';

      const updateButtons = () => {
        prevButton.disabled = currentIndex === 0;
        nextButton.disabled = currentIndex === slides.length - 1;
      };

      const moveToSlide = (index) => {
        currentTranslate = -index * slideWidth;
        track.style.transform = `translateX(${currentTranslate}px)`;
        prevTranslate = currentTranslate;
        currentIndex = index;
        updateButtons();
      };

      prevButton.addEventListener('click', () => moveToSlide(currentIndex - 1));
      nextButton.addEventListener('click', () => moveToSlide(currentIndex + 1));

      updateButtons();
    }

    function renderLogin() {
      const dom = document.getElementById('main');
      dom.innerHTML = `<div class="container">
        <div class="header" style="margin-bottom:24px;">Painel de Administração</div>
        <form id="loginform" style="background:#fff;padding:26px 22px;border-radius:var(--radius);box-shadow:0 2px 18px #0001;">
          <div class="form-grp"><label>Email:</label><input id="luser" type="email" required /></div>
          <div class="form-grp"><label>Senha:</label><input id="lsenha" type="password" required autocomplete="current-password" /></div>
          <div style="margin:14px 0;"><button type="submit" class="btn">Entrar</button></div> 
          <div id="loginError" style="color:#d00"></div>
        </form>
      </div>`;
      document.getElementById('loginform').onsubmit = async (e) => {
        e.preventDefault();
        try { await signInWithEmailAndPassword(auth, luser.value, lsenha.value); }
        catch { document.getElementById('loginError').innerText = "Login inválido!"; }
      }
    }

    async function renderAdmin() {
      const dom = document.getElementById('main');
      dom.innerHTML = `<div class="admin-container" style="text-align:center; padding-top: 40px;"><div class="spinner" style="margin:auto; border-color: #ccc; border-top-color: var(--primary);"></div></div>`;
      const palhacos = await getPalhacos();

      let list = '';
      if (palhacos.length === 0) {
        list = `<div style="text-align:center;color:#666;">Nenhum palhaço cadastrado.<br>Clique em <b>Adicionar Novo Palhaço</b> para começar!</div>`;
      } else {
        list = '<div class="card-list">';
        palhacos.forEach(p => {
          const shareLink = `${window.location.origin}${window.location.pathname}?id=${p.id}`;
            list += `<div class="admin-card" data-key="${p.key}">
            <img src="${p.photo}" class="card-photo" />
            <div class="card-info">
              <div style="font-weight:700;color:var(--primary);font-size:1.07em">${p.name}</div>
              <div style="font-size:0.96em;color:var(--secondary); margin-bottom: 8px;">${p.jobTitle ?? ''}</div>
              <div class="card-link">${shareLink}</div>
            </div>
              <div class="card-actions" data-share-link="${shareLink}" data-key="${p.key}" data-id="${p.id}">
                <button class="btn copiar-link"><i class="fa fa-copy"></i> Copiar Link</button>
                <button class="btn accent"><i class="fa fa-eye"></i> Ver Cartão</button>
                <button class="btn" style="background-color: #95a5a6;"><i class="fa fa-qrcode"></i> QR Code</button>
                <button class="btn secondary"><i class="fa fa-pen"></i> Editar</button>
                <button class="btn" style="background-color: #c0392b;"><i class="fa fa-trash"></i> Excluir</button>
            </div>
          </div>`;
        });
        list += "</div>";
      }
      dom.innerHTML = `
        <div class="header">Painel de Administração</div>
        <div class="admin-container">
          <div class="admin-btns" data-action-group="admin-main">
            <button class="btn accent" data-action="add-new">➕ Adicionar Novo Palhaço</button>
            <button class="btn logout" data-action="logout"><i class="fa fa-sign-out"></i> Sair</button>
          </div>
          <div>${list}</div>
        </div>
      `;
    }

    function copyLink(btn, link) {
      navigator.clipboard.writeText(link);
      const originalText = btn.innerHTML;
      btn.innerHTML = 'Copiado!';
      btn.classList.add('copied');
      setTimeout(() => { btn.innerHTML = originalText; btn.classList.remove('copied'); }, 2000);
    }
    
    function showQRCodeModal(url) {
      const modalBg = document.getElementById('modal-bg');
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(url)}`;
      // --- NOVO: Extrai o ID do palhaço para o nome do arquivo ---
      const palhacoId = new URL(url).searchParams.get('id') || 'cartao';
      const filename = `qrcode-${palhacoId}.png`;

      const html = `<div class="modal-box" style="text-align: center;">
        <button type="button" class="close-modal" data-action="close-modal">&times;</button>
        <div class="modal-title">Compartilhe o Cartão</div>
        <img src="${qrUrl}" alt="QR Code" style="border-radius: 10px; margin-bottom: 16px;" />
        <a href="${qrUrl}" download="${filename}" class="btn accent" style="display: inline-block; text-decoration: none; margin-bottom: 16px;">
          <i class="fa fa-download"></i> Baixar Imagem
        </a>
        <p style="font-size: 0.9em; color: #666; word-break: break-all;">${url}</p>
      </div>`;

      modalBg.innerHTML = html;
      modalBg.classList.add('active');
    }

    async function showEditModal(key) {
      document.getElementById('modal-bg').classList.add('active');
      let data = { name:"", id:"", photo:"", jobTitle:"", bio:"", instagram:"", facebook:"", twitter:"", linkedin:"", website:"", customLinks:[], color1: "#E74C3C", color2: "#F39C12", additionalImages: ["","","",""], sectionOrder: ['bio', 'social', 'images', 'links'] };
      let isEdit = false;
      if (key) {
        const ref = doc(db, "palhacos", key);
        const snap = await getDoc(ref);
        if (snap.exists()) { data = { ...data, ...snap.data() }; isEdit = true; } // Merge fetched data with defaults
      }
      renderModalForm(data, isEdit, key);
    }
    function closeModal() {
      document.getElementById('modal-bg').classList.remove('active');
      setTimeout(()=>document.getElementById('modal-bg').innerHTML='', 150);
    }
    function renderModalForm(data, isEdit, key) {
      let html = `<form id="palhacoForm" autocomplete="off" data-key="${key || ''}">
        <button type="button" class="close-modal" data-action="close-modal">&times;</button>
        <div class="modal-title">${isEdit ? "Editar Palhaço" : "Adicionar Novo Palhaço"}</div>
        <div class="form-grp"><label>Nome do Palhaço *</label>
          <input required id="f_nome" value="${data.name||""}" />
        </div>
        <div class="form-grp"><label>ID Único *</label>
          <input required id="f_id" value="${data.id||""}" pattern="[a-z0-9\\-]+" />
          <div style="font-size:0.9em;color:#888;margin-top:3px;">Link: <b>?id=${data.id||""}</b> (letras minúsculas, números, hífen)</div>
        </div>
        <div class="form-grp"><label>Foto - Escolher arquivo ou URL *</label>
          <input type="file" id="f_photo_file" accept="image/*" />
          <input required id="f_photo" value="${data.photo||""}" placeholder="URL da foto" style="margin-top:10px;" />
          <img src="${data.photo||''}" id="photo-preview" style="width:70px; height:70px; border-radius:50%; background:#eee; margin-top:7px; object-fit:cover; ${data.photo ? '' : 'display:none;'}" onerror="this.style.display='none';" />
        </div>
        <div class="form-grp"><label>Cargo/Função</label>
          <input id="f_role" value="${data.jobTitle||""}" />
        </div>
        <div class="form-grp"><label>Cores do Fundo do Cartão</label>
          <div style="display:flex; gap: 15px; align-items:center; flex-wrap: wrap;">
            <div>Cor 1: <input type="color" id="f_color1" value="${data.color1 || '#E74C3C'}"></div>
            <div>Cor 2: <input type="color" id="f_color2" value="${data.color2 || '#F39C12'}"></div>
            <div id="gradient-preview" style="width: 60px; height: 30px; border-radius: 8px; border: 1px solid #ccc; flex-shrink: 0;"></div>
          </div>
          <div style="font-size:0.9em;color:#888;margin-top:3px;">Deixe como está para usar o padrão laranja.</div>
        </div>
        
        <div id="reorderable-sections-container" style="display: flex; flex-direction: column; gap: 16px; margin-top: 16px;">
        <!-- As seções reordenáveis serão inseridas aqui pelo JS -->
        </div>

        <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
          <button type="button" class="btn secondary" data-action="close-modal">Cancelar</button>
          <button type="submit" class="btn" style="background:#27ae60;">Salvar</button>
        </div>
        <div id="form-err" style="color:#d00;margin-top:10px;"></div>
      </form>`;
      document.getElementById('modal-bg').innerHTML = `<div class="modal-box">${html}</div>`;

      // --- NOVO: Lógica para renderizar e reordenar seções do formulário ---
      const reorderableContainer = document.getElementById('reorderable-sections-container');
      const sectionOrder = data.sectionOrder || ['bio', 'social', 'images', 'links'];
      
      const sectionsHTML = {
        bio: `<div class="form-grp form-section" data-section-id="bio" draggable="true">
                <div class="form-section-header"><i class="fa fa-grip-vertical"></i><label>Bio</label></div>
                <textarea id="f_bio">${data.bio||""}</textarea>
              </div>`,
        social: `<div class="form-grp form-section" data-section-id="social" draggable="true">
                  <div class="form-section-header"><i class="fa fa-grip-vertical"></i><label>Redes Sociais</label></div>
                  <input id="f_instagram" placeholder="Instagram (somente username ou link)" value="${data.instagram||""}" style="margin-bottom:6px;" />
                  <input id="f_facebook" placeholder="Facebook (somente username ou link)" value="${data.facebook||""}" style="margin-bottom:6px;" />
                  <input id="f_twitter" placeholder="Twitter/X (somente username ou link)" value="${data.twitter||""}" style="margin-bottom:6px;" />
                  <input id="f_linkedin" placeholder="LinkedIn (somente username ou link)" value="${data.linkedin||""}" style="margin-bottom:6px;" />
                  <input id="f_website" placeholder="Site Pessoal (URL completo ou sem http)" value="${data.website||""}" />
                </div>`,
        images: `<div class="form-grp form-section" data-section-id="images" draggable="true">
                  <div class="form-section-header"><i class="fa fa-grip-vertical"></i><label>Imagens Adicionais (até 4)</label></div>
                  <div id="additional-photos-container"></div>
                  <div style="font-size:0.9em;color:#888;margin-top:3px;">Arraste as imagens para reordená-las.</div>
                </div>`,
        links: `<div class="form-grp form-section" data-section-id="links" draggable="true">
                  <div class="form-section-header"><i class="fa fa-grip-vertical"></i><label>Links Personalizados</label></div>
                  <div class="custom-links" id="custom-links"></div>
                  <button type="button" class="btn accent" data-action="add-custom-link" style="padding: 8px 16px; font-size: 0.9em; margin-top: 8px;">+ Adicionar Link</button>
                </div>`
      };

      // Renderiza as seções na ordem correta
      sectionOrder.forEach(id => {
        if(sectionsHTML[id]) reorderableContainer.innerHTML += sectionsHTML[id];
      });

      // Preenche os links personalizados (que agora estão dentro de uma seção)
      const customLinksContainer = document.getElementById('custom-links');
      if (customLinksContainer) {
        (data.customLinks||[]).forEach((lk,i)=>{
          const linkRow = document.createElement('div');
          linkRow.className = 'custom-link-row';
          linkRow.innerHTML = `
            <input value="${lk.title||""}" placeholder="Título do Link" />
            <input value="${lk.url||""}" placeholder="URL completa (https://...)" />
            <button type="button" class="btn-icon btn-danger" onclick="this.parentElement.remove()">×</button>
          `;
          customLinksContainer.appendChild(linkRow);
        });
      }

      // Initialize and update gradient preview
      const updateGradientPreview = () => {
        const color1 = document.getElementById('f_color1').value;
        const color2 = document.getElementById('f_color2').value;
        document.getElementById('gradient-preview').style.background = `linear-gradient(135deg, ${color1} 0%, ${color2} 100%)`;
      };

      // Set initial preview and add event listeners
      updateGradientPreview();
      document.getElementById('f_color1').oninput = updateGradientPreview;
      document.getElementById('f_color2').oninput = updateGradientPreview;
      // Upload Handler

      // --- NOVO: Lógica para Imagens Adicionais com Upload e Drag-n-Drop ---
      const additionalPhotosContainer = document.getElementById('additional-photos-container');
      for (let i = 0; i < 4; i++) {
        const photoUrl = (data.additionalImages && data.additionalImages[i]) ? data.additionalImages[i] : '';
        const div = document.createElement('div');
        div.className = 'additional-photo-row';
        div.draggable = true;
        div.style.cssText = 'display:flex; align-items:center; gap:10px; margin-bottom:10px; padding:8px; border:1px solid #eee; border-radius:8px; cursor:grab;';
        div.innerHTML = `
          <i class="fa fa-grip-vertical" style="color:#aaa;"></i>
          <img id="extra_photo_preview_${i}" src="${photoUrl}" style="width:50px; height:50px; border-radius:8px; background:#eee; object-fit:cover; ${photoUrl ? '' : 'display:none;'}" onerror="this.style.display='none';" />
          <div style="flex:1;">
            <input type="file" id="f_extra_photo_file_${i}" accept="image/*" style="display:none;" />
            <button type="button" onclick="document.getElementById('f_extra_photo_file_${i}').click()" class="btn" style="padding: 5px 10px; font-size:0.8em;">Escolher</button>
            <span id="upload_status_${i}" style="font-size:0.8em; color:#888; margin-left:5px;"></span>
            <input type="hidden" id="f_extra_photo_url_${i}" value="${photoUrl}" />
          </div>
          <button type="button" class="btn-icon" onclick="this.closest('.additional-photo-row').querySelector('input[type=hidden]').value=''; this.closest('.additional-photo-row').querySelector('img').style.display='none';" style="color:#d00;font-size:1.4em;">&times;</button>
        `;
        additionalPhotosContainer.appendChild(div);

        document.getElementById(`f_extra_photo_file_${i}`).onchange = function(e) {
          const file = e.target.files[0];
          if (!file) return;
          const statusEl = document.getElementById(`upload_status_${i}`);
          statusEl.textContent = 'Enviando...';
          const fileName = `${Date.now()}-${file.name.replace(/[^a-zA-Z0-9.]/g, "")}`; 
          const storageRef = stRef(storage, 'palhacos_extra/' + fileName);
          const uploadTask = uploadBytesResumable(storageRef, file);
          uploadTask.on('state_changed', 
            (snapshot) => {},
            (error) => { statusEl.textContent = "Erro!"; },
            async () => {
              const url = await getDownloadURL(storageRef);
              document.getElementById(`f_extra_photo_url_${i}`).value = url;
              const preview = document.getElementById(`extra_photo_preview_${i}`);
              preview.src = url;
              preview.style.display = 'block';
              statusEl.textContent = 'Enviado!';
              setTimeout(() => statusEl.textContent = '', 2000);
            }
          );
        };
      }

      // Drag and Drop Logic
      let draggingElement = null;
      additionalPhotosContainer.addEventListener('dragstart', e => {
        draggingElement = e.target.closest('.additional-photo-row');
        draggingElement.style.opacity = '0.5';
      });
      additionalPhotosContainer.addEventListener('dragover', e => {
        e.preventDefault();
        const target = e.target.closest('.additional-photo-row');
        if (target && target !== draggingElement) {
          const rect = target.getBoundingClientRect();
          const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > 0.5;
          additionalPhotosContainer.insertBefore(draggingElement, next && target.nextSibling || target);
        }
      });
      additionalPhotosContainer.addEventListener('dragend', e => {
        if (draggingElement) {
          draggingElement.style.opacity = '1';
          draggingElement = null;
        }
      });
      additionalPhotosContainer.addEventListener('drop', e => {
        e.preventDefault();
      });

      // Drag and Drop para Seções do Formulário
      let draggingSection = null;
      reorderableContainer.addEventListener('dragstart', e => {
        if (e.target.classList.contains('form-section')) {
          draggingSection = e.target;
          draggingSection.style.opacity = '0.5';
        }
      });
      reorderableContainer.addEventListener('dragover', e => {
        e.preventDefault();
        const target = e.target.closest('.form-section');
        if (target && target !== draggingSection) {
          const rect = target.getBoundingClientRect();
          const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > 0.5;
          reorderableContainer.insertBefore(draggingSection, next && target.nextSibling || target);
        }
      });
      reorderableContainer.addEventListener('dragend', e => {
        if (draggingSection) {
          draggingSection.style.opacity = '1';
          draggingSection = null;
        }
      });

      document.getElementById('f_photo_file').onchange = async function(e){
        const file = e.target.files[0];
        if (!file) return;
        document.getElementById('f_photo').value = "Enviando...";
        const fileName = `${Date.now()}-${file.name.replace(/[^a-zA-Z0-9.]/g, "")}`; 
        const storageRef = stRef(storage, 'palhacos/' + fileName);
        const uploadTask = uploadBytesResumable(storageRef, file);
        uploadTask.on('state_changed', 
          (snapshot) => {},
          (error) => {formErr("Erro ao enviar imagem.");},
          async () => {
            const url = await getDownloadURL(storageRef);
            document.getElementById('f_photo').value = url;
            const preview = document.getElementById('photo-preview');
            preview.src = url;
            preview.style.display = 'block';
          }
        );
      } 
      document.getElementById('f_photo').oninput = function(){
        const preview = document.getElementById('photo-preview');
        preview.src = this.value;
        preview.style.display = this.value ? 'block' : 'none';
      }
      document.getElementById('palhacoForm').onsubmit = async function(e){
        e.preventDefault();
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const name = f_nome.value.trim();
        const id = f_id.value.trim().toLowerCase();
        const photo = f_photo.value.trim();
        if (!name || !id || !photo) { formErr("Campos obrigatórios!"); return;}
        if (!id.match(/^[a-z0-9\-]+$/)) { formErr("ID inválido! Use letras minúsculas, números, hífen."); return; }
        let allPalhacos = await getPalhacos();
        if ((!isEdit || key===undefined) && allPalhacos.find(x=>x.id===id)) { formErr("ID já existe!"); return; }
        let customLinks = [];
        Array.from(document.getElementById('custom-links').children).forEach(row=>{
          const title = row.children[0].value.trim();
          const url = row.children[1].value.trim();
          if(title && url) customLinks.push({title,url});
        });

        let additionalImages = [];
        const rows = document.querySelectorAll('.additional-photo-row');
        rows.forEach(row => {
          const urlInput = row.querySelector('input[type=hidden]');
          additionalImages.push(urlInput.value.trim());
        });

        // --- NOVO: Captura a nova ordem das seções ---
        let sectionOrder = [];
        const sectionElements = document.querySelectorAll('#reorderable-sections-container .form-section');
        sectionElements.forEach(section => {
          sectionOrder.push(section.dataset.sectionId);
        });

        // --- MELHORIA: Deletar imagens que foram removidas do formulário ---
        if (isEdit) {
          const originalImages = data.additionalImages || [];
          const imagesToDelete = originalImages.filter(url => url && !additionalImages.includes(url));
          
          const deletePromises = imagesToDelete.map(url => deleteObject(stRef(storage, url)).catch(err => console.warn("Imagem a ser deletada não foi encontrada:", url)));
          await Promise.all(deletePromises);
        }
        // --- Fim da melhoria ---

        let obj = {
          name, id, photo,
          jobTitle: f_role.value,
          bio: f_bio.value,
          instagram: f_instagram.value,
          facebook: f_facebook.value,
          twitter: f_twitter.value,
          linkedin: f_linkedin.value,
          website: f_website.value,
          customLinks,
          color1: f_color1.value, // Cor 1 do degradê
          color2: f_color2.value, // Cor 2 do degradê
          additionalImages, // Novas imagens adicionais
          sectionOrder // Nova ordem das seções
        };
        submitBtn.disabled = true;
        submitBtn.innerText = "Salvando...";
        if (isEdit && key) {
          await updatePalhaco(key, obj);
        } else {
          await createPalhaco(obj);
        }
        closeModal();
        // Pequeno delay para garantir que o usuário veja a transição
        setTimeout(renderAdmin, 100);
        renderAdmin();
      }
    }
    function formErr(msg){ document.getElementById('form-err').innerText = msg; }
    function addCustomLink() {
      const c = document.createElement('div');
      c.className="custom-link-row";
      c.innerHTML = `<input placeholder="Título do Link" /> <input placeholder="URL completa (https://...)" /> <button type="button" class="btn-icon btn-danger" onclick="this.parentElement.remove()">×</button>`;
      document.getElementById('custom-links').appendChild(c);
    } 
    async function excluirPalhaco(key) {
      if (confirm("Excluir este palhaço?")) {
        try {
          // --- MELHORIA: Excluir imagens do Storage antes de apagar o documento ---
          const palhacoRef = doc(db, "palhacos", key);
          const palhacoSnap = await getDoc(palhacoRef);

          if (palhacoSnap.exists()) {
            const palhacoData = palhacoSnap.data();
            const imagesToDelete = [];
            if (palhacoData.photo) imagesToDelete.push(palhacoData.photo);
            if (palhacoData.additionalImages) {
              palhacoData.additionalImages.forEach(imgUrl => {
                if (imgUrl) imagesToDelete.push(imgUrl);
              });
            }

            // Deleta cada imagem do Storage
            const deletePromises = imagesToDelete.map(url => deleteObject(stRef(storage, url)).catch(err => console.warn("Imagem não encontrada para deletar:", url)));
            await Promise.all(deletePromises);
          }

          await delPalhaco(key); // Apaga o documento do Firestore
          // Otimização: Em vez de recarregar tudo, apenas remove o card do DOM.
          const cardElement = document.querySelector(`.admin-card[data-key="${key}"]`);
          if (cardElement) {
            cardElement.style.transition = 'opacity 0.5s, transform 0.5s';
            cardElement.style.opacity = '0';
            cardElement.style.transform = 'scale(0.9)';
            setTimeout(() => cardElement.remove(), 500);
          } else {
            renderAdmin(); // Fallback se o elemento não for encontrado
          }
        } catch (error) {
          console.error("Erro ao excluir palhaço e suas imagens:", error);
          alert("Ocorreu um erro ao excluir o palhaço.");
        }
      }
    }
    window.logout = function () { signOut(auth); }
    function logout() { signOut(auth); }

    onAuthStateChanged(auth, (user) => {
      const idParam = getParamId();
      if (idParam) renderIndvCard(idParam);
      else if (user) renderAdmin();
      else renderLogin();
    });

    // Otimização: Delegação de Eventos
    document.body.addEventListener('click', (e) => {
      const target = e.target;
      const closestAction = target.closest('[data-action]');
      const finalAction = closestAction ? closestAction.dataset.action : null;

      if (finalAction === 'close-modal') {
        closeModal();
      } else if (finalAction === 'add-new') {
        showEditModal();
      } else if (finalAction === 'logout') {
        logout();
      } else if (finalAction === 'add-custom-link') {
        addCustomLink();
      }

      const actionsContainer = target.closest('.card-actions');
      if (actionsContainer) {
        if (target.closest('.copiar-link')) copyLink(target.closest('.copiar-link'), actionsContainer.dataset.shareLink);
        if (target.closest('.accent')) window.open(`?id=${actionsContainer.dataset.id}`, '_blank');
        if (target.closest('[style*="95a5a6"]')) showQRCodeModal(actionsContainer.dataset.shareLink);
        if (target.closest('.secondary')) showEditModal(actionsContainer.dataset.key);
        if (target.closest('[style*="c0392b"]')) excluirPalhaco(actionsContainer.dataset.key);
      }
    });
    document.getElementById('modal-bg').onclick = function (e) { if (e.target === this) closeModal(); }
  </script>
</body>
</html>
